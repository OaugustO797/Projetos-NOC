<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOC Unified Toolkit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light dark;
      --sidebar-width: 270px;
      --transition: 0.25s ease;
      --font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-family);
      background: var(--bg-main, #0f172a);
      color: var(--text-primary, #e2e8f0);
      min-height: 100vh;
      display: flex;
    }

    a {
      color: inherit;
    }

    .app {
      display: flex;
      width: 100%;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar-bg, #111827);
      color: var(--sidebar-text, #f8fafc);
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border-color, rgba(148, 163, 184, 0.2));
    }

    .sidebar header {
      padding: 24px 24px 16px;
      border-bottom: 1px solid var(--border-color, rgba(148, 163, 184, 0.2));
    }

    .sidebar h1 {
      margin: 0;
      font-size: 1.3rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sidebar h1 span:first-child {
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .sidebar nav {
      display: flex;
      flex-direction: column;
      padding: 12px 8px;
      gap: 8px;
    }

    .sidebar button.tab {
      background: transparent;
      border: none;
      color: inherit;
      text-align: left;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.98rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), transform var(--transition);
    }

    .sidebar button.tab:hover {
      transform: translateX(4px);
      background: rgba(59, 130, 246, 0.1);
    }

    .sidebar button.tab.active {
      background: rgba(59, 130, 246, 0.2);
      color: var(--accent, #3b82f6);
      font-weight: 600;
    }

    main {
      flex: 1;
      padding: 32px;
      background: var(--bg-subtle, #0b1120);
      overflow-y: auto;
    }

    h2 {
      margin-top: 0;
      font-size: 1.4rem;
    }

    .panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
    }

    .card {
      background: var(--surface, rgba(15, 23, 42, 0.8));
      border: 1px solid var(--border-color, rgba(148, 163, 184, 0.2));
      border-radius: 16px;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.25);
      backdrop-filter: blur(12px);
      transition: transform var(--transition), box-shadow var(--transition);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 28px 60px rgba(15, 23, 42, 0.28);
    }

    label {
      font-weight: 500;
      font-size: 0.92rem;
    }

    textarea,
    input[type="date"] {
      width: 100%;
      background: var(--surface-muted, rgba(15, 23, 42, 0.6));
      color: inherit;
      border: 1px solid var(--border-color, rgba(148, 163, 184, 0.25));
      border-radius: 12px;
      padding: 12px 14px;
      font-family: var(--font-family);
      font-size: 0.95rem;
      transition: border var(--transition), box-shadow var(--transition);
      resize: vertical;
      min-height: 200px;
    }

    textarea:focus,
    input[type="date"]:focus {
      outline: none;
      border-color: var(--accent, #3b82f6);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
    }

    input[type="date"] {
      min-height: auto;
      cursor: pointer;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    button {
      font-family: var(--font-family);
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }

    .btn-primary {
      background: var(--accent, #3b82f6);
      color: #fff;
      box-shadow: 0 12px 28px rgba(59, 130, 246, 0.25);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 34px rgba(59, 130, 246, 0.3);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border-color, rgba(148, 163, 184, 0.3));
      color: inherit;
    }

    .btn-outline:hover {
      background: rgba(59, 130, 246, 0.12);
      border-color: var(--accent, #3b82f6);
      color: var(--accent, #3b82f6);
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.45);
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.25);
    }

    .formatter-output {
      min-height: 200px;
      white-space: pre-wrap;
      background: var(--surface-muted, rgba(15, 23, 42, 0.6));
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border-color, rgba(148, 163, 184, 0.25));
      font-family: 'Fira Code', 'JetBrains Mono', 'SFMono-Regular', ui-monospace, monospace;
      font-size: 0.92rem;
    }

    .counters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .counter {
      flex: 1;
      min-width: 120px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(59, 130, 246, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .counter span {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .counter strong {
      font-size: 1.6rem;
      font-weight: 700;
    }

    .counter.green {
      background: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.3);
      color: #4ade80;
    }

    .counter.red {
      background: rgba(248, 113, 113, 0.1);
      border-color: rgba(248, 113, 113, 0.3);
      color: #fca5a5;
    }

    .counter.blue {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
      color: #93c5fd;
    }

    .days-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .day-chip {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.15);
      border: 1px solid rgba(148, 163, 184, 0.25);
      font-size: 0.85rem;
    }

    .formatter-history-wrapper {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .formatter-history {
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .formatter-history-group {
      border: 1px solid var(--border-color, rgba(148, 163, 184, 0.25));
      border-radius: 14px;
      padding: 12px;
      background: var(--surface-muted, rgba(15, 23, 42, 0.55));
    }

    .formatter-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .formatter-history-header h4 {
      margin: 0;
      font-size: 1rem;
    }

    .formatter-history-entry {
      margin-top: 12px;
      border-top: 1px solid rgba(148, 163, 184, 0.25);
      padding-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .formatter-history-entry pre {
      margin: 0;
      white-space: pre-wrap;
      background: rgba(15, 23, 42, 0.45);
      padding: 10px;
      border-radius: 10px;
      font-size: 0.85rem;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .formatter-history-entry .entry-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.78rem;
      color: rgba(226, 232, 240, 0.75);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.28);
    }

    thead {
      background: rgba(59, 130, 246, 0.1);
      color: var(--accent, #3b82f6);
    }

    th, td {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      text-align: left;
      font-size: 0.92rem;
    }

    tbody tr:hover {
      background: rgba(148, 163, 184, 0.08);
    }

    td[data-col="observacao"] {
      background: rgba(59, 130, 246, 0.05);
    }

    td[data-col="atuacao"][data-value="SIM"] {
      color: #f87171;
      font-weight: 600;
    }

    td[data-col="atuacao"][data-value="N√ÉO"] {
      color: #34d399;
      font-weight: 600;
    }

    .filter-trigger {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      margin-left: 6px;
      font-size: 0.8rem;
    }

    .filter-bar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 12px;
    }

    .filter-menu {
      position: absolute;
      z-index: 1000;
      min-width: 200px;
      max-height: 260px;
      overflow-y: auto;
      background: var(--surface, rgba(15, 23, 42, 0.96));
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-menu button {
      background: rgba(148, 163, 184, 0.08);
      border: none;
      border-radius: 8px;
      padding: 8px 10px;
      text-align: left;
      cursor: pointer;
      color: inherit;
    }

    .filter-menu button:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .history-item {
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 14px;
      padding: 16px;
      background: var(--surface-muted, rgba(15, 23, 42, 0.6));
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .history-content {
      margin-top: 14px;
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    .history-item.open .history-content {
      display: flex;
    }

    .badge {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent, #3b82f6);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .config-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: background var(--transition), color var(--transition);
    }

    .theme-toggle:hover {
      background: rgba(59, 130, 246, 0.2);
      color: #fff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    @media (max-width: 920px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        border-right: none;
        border-bottom: 1px solid var(--border-color, rgba(148, 163, 184, 0.2));
      }

      .sidebar header {
        border-bottom: none;
      }

      .sidebar nav {
        flex-direction: row;
        flex-wrap: wrap;
        padding: 12px;
      }

      main {
        padding: 24px;
      }
    }

    .light-theme body {
      --bg-main: #f8fafc;
      --bg-subtle: #f1f5f9;
      --surface: rgba(255, 255, 255, 0.9);
      --surface-muted: rgba(248, 250, 252, 0.9);
      --text-primary: #0f172a;
      --border-color: rgba(148, 163, 184, 0.4);
      --sidebar-bg: #1e293b;
      --sidebar-text: #f8fafc;
      --accent: #2563eb;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <header>
        <h1>
          <span>NOC Unified</span>
          <span>Checklist & Formatter</span>
        </h1>
      </header>
      <nav>
        <button class="tab active" data-tab="panel">üìã Painel</button>
        <button class="tab" data-tab="history">üïí Hist√≥rico</button>
        <button class="tab" data-tab="config">‚öôÔ∏è Configura√ß√µes</button>
      </nav>
    </aside>
    <main>
      <section id="panel" class="tab-content active">
        <div class="panel-grid">
          <div class="card" id="formatter-card">
            <div>
              <h2>üß† NOC Formatter</h2>
              <p>Padronize listas de hor√°rios com contadores e hist√≥rico autom√°tico.</p>
            </div>
            <label for="formatter-input">Lista bruta</label>
            <textarea id="formatter-input" placeholder="Cole aqui a lista a ser formatada..."></textarea>
            <div class="btn-row">
              <button class="btn btn-primary" id="btn-format">Formatar Lista</button>
              <button class="btn btn-outline" id="btn-copy-output">Copiar lista</button>
              <button class="btn btn-outline" id="btn-export-txt">Exportar TXT</button>
              <button class="btn btn-danger" id="btn-clear-formatter">Limpar lista</button>
            </div>
            <div>
              <h3>Sa√≠da formatada</h3>
              <pre id="formatter-output" class="formatter-output" tabindex="0"></pre>
            </div>
            <div class="counters">
              <div class="counter green">
                <span>Servi√ßo em execu√ß√£o</span>
                <strong id="counter-green">0</strong>
              </div>
              <div class="counter red">
                <span>Necessitam atua√ß√£o</span>
                <strong id="counter-red">0</strong>
              </div>
              <div class="counter blue">
                <span>Total</span>
                <strong id="counter-total">0</strong>
              </div>
            </div>
            <div>
              <h4>Dias detectados</h4>
              <div class="days-list" id="formatter-days"></div>
            </div>
            <div class="formatter-history-wrapper">
              <h3>Hist√≥rico do Formatter</h3>
              <div class="formatter-history" id="formatter-history"></div>
            </div>
          </div>
          <div class="card" id="checklist-input-card">
            <div>
              <h2>‚ûï NOC Checklist</h2>
              <p>Transforme registros em checklist estruturada com filtros e exporta√ß√µes.</p>
            </div>
            <label for="panel-date">Data base</label>
            <input type="date" id="panel-date">
            <label for="panel-input">Entrada de registros</label>
            <textarea id="panel-input" placeholder="Cole aqui os registros com cabe√ßalhos de data..."></textarea>
            <div class="btn-row">
              <button class="btn btn-primary" id="btn-add-records">‚ûï Adicionar</button>
              <button class="btn btn-danger" id="btn-clear-table">üßπ Apagar todos</button>
              <button class="btn btn-outline" id="btn-export-csv">üì§ Exportar CSV</button>
              <button class="btn btn-outline" id="btn-export-xlsx">üì§ Exportar XLSX</button>
              <button class="btn btn-outline" id="btn-export-txt-table">üì§ Exportar TXT</button>
            </div>
            <div class="filter-bar">
              <button class="btn btn-outline" id="btn-clear-filters">Limpar filtros</button>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>DataHora <button class="filter-trigger" data-column="datahora">‚ñº</button></th>
                    <th>Servi√ßo <button class="filter-trigger" data-column="servico">‚ñº</button></th>
                    <th>Empresa <button class="filter-trigger" data-column="empresa">‚ñº</button></th>
                    <th>Observa√ß√£o <button class="filter-trigger" data-column="observacao">‚ñº</button></th>
                    <th>Atua√ß√£o <button class="filter-trigger" data-column="atuacao">‚ñº</button></th>
                  </tr>
                </thead>
                <tbody id="records-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      <section id="history" class="tab-content">
        <h2>üïí Hist√≥rico consolidado</h2>
        <p>Revise, exporte ou remova envios anteriores agrupados por data.</p>
        <div class="history-list" id="history-list"></div>
      </section>
      <section id="config" class="tab-content">
        <h2>‚öôÔ∏è Configura√ß√µes</h2>
        <div class="config-group">
          <span>Tema da interface</span>
          <button class="theme-toggle" id="btn-toggle-theme">Alternar tema</button>
        </div>
        <div class="config-group">
          <span>Dados</span>
          <button class="btn btn-danger" id="btn-clear-all">Limpar tudo</button>
        </div>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-8dLOcAfeUOLuO/7ipJcG1W/1LxwDyEsw7biRye3Bl7VKFoJG6vGdlGwx1F7wtUEOYEYf0ZfBa4Q1L5G2NsqQvg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    const storageKeys = {
      theme: 'nocChecklistTheme',
      records: 'nocChecklistRecords',
      history: 'nocChecklistHistory',
      formatterHistory: 'nocFormatterHistory'
    };

    const state = {
      theme: 'dark',
      records: [],
      history: [],
      filters: {
        datahora: null,
        servico: null,
        empresa: null,
        observacao: null,
        atuacao: null
      },
      formatterHistory: []
    };

    const formatterOutputEl = document.getElementById('formatter-output');
    const formatterDaysEl = document.getElementById('formatter-days');
    const formatterHistoryEl = document.getElementById('formatter-history');
    const counterGreen = document.getElementById('counter-green');
    const counterRed = document.getElementById('counter-red');
    const counterTotal = document.getElementById('counter-total');
    const recordsBody = document.getElementById('records-body');
    const historyList = document.getElementById('history-list');

    const tabs = document.querySelectorAll('.sidebar button.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.dataset.tab;
        tabContents.forEach(section => {
          section.classList.toggle('active', section.id === target);
        });
      });
    });

    function todayYMD() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    }

    function norm(str) {
      return (str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }

    function toISO8601Z(year, month, day, hour, minute) {
      const localDate = new Date(year, month - 1, day, hour, minute, 0, 0);
      return localDate.toISOString().replace(/\.\d{3}Z$/, 'Z');
    }

    function saveAll() {
      localStorage.setItem(storageKeys.theme, state.theme);
      localStorage.setItem(storageKeys.records, JSON.stringify(state.records));
      localStorage.setItem(storageKeys.history, JSON.stringify(state.history));
      localStorage.setItem(storageKeys.formatterHistory, JSON.stringify(state.formatterHistory));
    }

    function loadAll() {
      try {
        const storedTheme = localStorage.getItem(storageKeys.theme);
        if (storedTheme) state.theme = storedTheme;
      } catch (err) {
        console.warn('Tema n√£o p√¥de ser carregado', err);
      }

      try {
        const storedRecords = localStorage.getItem(storageKeys.records);
        if (storedRecords) state.records = JSON.parse(storedRecords) || [];
      } catch (err) {
        console.warn('Registros n√£o puderam ser carregados', err);
      }

      try {
        const storedHistory = localStorage.getItem(storageKeys.history);
        if (storedHistory) state.history = JSON.parse(storedHistory) || [];
      } catch (err) {
        console.warn('Hist√≥rico n√£o p√¥de ser carregado', err);
      }

      try {
        const storedFormatterHistory = localStorage.getItem(storageKeys.formatterHistory);
        if (storedFormatterHistory) state.formatterHistory = JSON.parse(storedFormatterHistory) || [];
      } catch (err) {
        console.warn('Hist√≥rico do formatter n√£o p√¥de ser carregado', err);
      }
    }

    function applyTheme(theme) {
      state.theme = theme;
      if (theme === 'light') {
        document.documentElement.classList.add('light-theme');
      } else {
        document.documentElement.classList.remove('light-theme');
      }
      saveAll();
    }

    document.getElementById('btn-toggle-theme').addEventListener('click', () => {
      const newTheme = state.theme === 'dark' ? 'light' : 'dark';
      applyTheme(newTheme);
    });

    function downloadFile(filename, blob) {
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(link.href), 2000);
    }

    function formatStatus(text) {
      if (!text) return '';
      const normalized = norm(text);
      if (normalized.includes('necessario reinicio') || normalized.includes('necessario atuacao') || normalized.includes('necessario execucao') || normalized.includes('necessario a execucao')) {
        return 'Necess√°rio execu√ß√£o do servi√ßo.';
      }
      if (normalized.includes('servico em execucao')) {
        return 'Servi√ßo em execu√ß√£o.';
      }
      if (normalized.includes('sem necessidade de atuacao') || normalized.includes('sem atuacao')) {
        return 'Sem atua√ß√£o.';
      }
      return text.trim().replace(/\.+$/, '') + '.';
    }

    function parseFormatter(raw) {
      const lines = raw.split(/\r?\n/).map(line => line.trim()).filter(Boolean);
      if (!lines.length) {
        return null;
      }

      let dateLineIndex = lines.findIndex(line => /\d{2}\/\d{2}\/\d{4}/.test(line));
      if (dateLineIndex === -1) dateLineIndex = 0;
      const firstDateMatch = lines[dateLineIndex].match(/(\d{2})\/(\d{2})\/(\d{4})/);
      if (!firstDateMatch) {
        return null;
      }

      let baseDate = new Date(`${firstDateMatch[3]}-${firstDateMatch[2]}-${firstDateMatch[1]}T00:00:00`);
      let currentDate = new Date(baseDate);
      const formatted = [];
      const detectedDays = new Set([firstDateMatch[0]]);
      let lastMinutes = null;
      let green = 0;
      let red = 0;

      const timeRegexReplacements = [
        { regex: /(\d{2})h(\d{2})/gi, replace: '$1:$2' },
        { regex: /\[(\d{2}:\d{2})\]/g, replace: '$1' },
        { regex: /(\d{2}:\d{2})h/gi, replace: '$1' }
      ];

      lines.forEach((originalLine, index) => {
        if (index === dateLineIndex) return;
        let line = originalLine;
        const dateLine = line.match(/^\|?\s*(\d{2})\/(\d{2})\/(\d{4})$/);
        if (dateLine) {
          currentDate = new Date(`${dateLine[3]}-${dateLine[2]}-${dateLine[1]}T00:00:00`);
          detectedDays.add(`${dateLine[1]}/${dateLine[2]}/${dateLine[3]}`);
          lastMinutes = null;
          return;
        }
        timeRegexReplacements.forEach(({ regex, replace }) => {
          line = line.replace(regex, replace);
        });
        line = line.replace(/[‚Äì‚Äî]/g, '-');
        const timeMatch = line.match(/(\d{2}):(\d{2})/);
        const time = timeMatch ? `${timeMatch[1]}:${timeMatch[2]}` : '00:00';
        const minutes = parseInt(time.slice(0, 2), 10) * 60 + parseInt(time.slice(3), 10);

        if (lastMinutes !== null && minutes < lastMinutes) {
          const diff = lastMinutes - minutes;
          if (diff >= 720) {
            currentDate.setDate(currentDate.getDate() + 1);
            detectedDays.add(currentDate.toLocaleDateString('pt-BR'));
          }
        }
        lastMinutes = minutes;

        let withoutTime = line;
        if (timeMatch) {
          withoutTime = withoutTime.replace(timeMatch[0], '').replace(/^-/, '').trim();
        }

        let parts = withoutTime.split(/\s*-\s*/).map(p => p.trim()).filter(Boolean);
        let service = '';
        let empresa = '';
        let status = '';
        let rest = [];

        if (parts.length >= 3) {
          [service, empresa, ...rest] = parts;
          status = rest.join(' - ');
        } else {
          const serviceMatch = withoutTime.match(/\b([A-Z][A-Z0-9]{3,})\b/);
          service = serviceMatch ? serviceMatch[1] : 'SERVICO';
          const empresaMatch = withoutTime.match(/\b([A-Z]{3})\b/);
          empresa = empresaMatch ? empresaMatch[1] : 'EMP';
          status = withoutTime.replace(service, '').replace(empresa, '').replace(/^-/, '').trim();
        }

        service = service
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .toUpperCase()
          .replace(/[^A-Z0-9]/g, '');
        if (service.length < 4) {
          service = 'SERVICO';
        }
        empresa = normalizeCompany(empresa);
        status = formatStatus(status || withoutTime);
        if (!status) {
          status = 'Sem atua√ß√£o.';
        }

        const statusNorm = norm(status);
        if (statusNorm.includes('servico em execucao')) green++;
        if (statusNorm.includes('necessario reinicio') || statusNorm.includes('necessario atuacao') || statusNorm.includes('necessario execucao') || statusNorm.includes('necessario a execucao')) {
          red++;
        }

        const dateStr = `${String(currentDate.getDate()).padStart(2, '0')}/${String(currentDate.getMonth() + 1).padStart(2, '0')}/${currentDate.getFullYear()}`;
        formatted.push(`${time} - ${service} - ${empresa} - ${status}`);
      });

      const blue = formatted.length;

      return {
        text: formatted.join('\n'),
        days: Array.from(detectedDays),
        counters: {
          green,
          red,
          blue
        },
        baseDate: `${baseDate.getFullYear()}-${String(baseDate.getMonth() + 1).padStart(2, '0')}-${String(baseDate.getDate()).padStart(2, '0')}`
      };
    }

    function renderFormatterOutput(result) {
      if (!result) {
        formatterOutputEl.textContent = '';
        counterGreen.textContent = '0';
        counterRed.textContent = '0';
        counterTotal.textContent = '0';
        formatterDaysEl.innerHTML = '';
        return;
      }
      formatterOutputEl.textContent = result.text;
      counterGreen.textContent = result.counters.green;
      counterRed.textContent = result.counters.red;
      counterTotal.textContent = result.counters.blue;
      formatterDaysEl.innerHTML = '';
      result.days.forEach(day => {
        const chip = document.createElement('span');
        chip.className = 'day-chip';
        chip.textContent = day;
        formatterDaysEl.appendChild(chip);
      });
    }

    function addFormatterHistoryEntry(result) {
      if (!result) return;
      const id = crypto.randomUUID ? crypto.randomUUID() : `fmt-${Date.now()}`;
      const createdAt = new Date().toISOString();
      const groupIndex = state.formatterHistory.findIndex(group => group.dateYMD === result.baseDate);
      const entry = {
        id,
        createdAt,
        text: result.text,
        counters: result.counters,
        days: result.days
      };
      if (groupIndex >= 0) {
        state.formatterHistory[groupIndex].entries.unshift(entry);
      } else {
        state.formatterHistory.unshift({
          dateYMD: result.baseDate,
          entries: [entry]
        });
      }
      saveAll();
      renderFormatterHistory();
    }

    function renderFormatterHistory() {
      formatterHistoryEl.innerHTML = '';
      if (!state.formatterHistory.length) {
        const empty = document.createElement('p');
        empty.textContent = 'Sem hist√≥rico at√© o momento.';
        formatterHistoryEl.appendChild(empty);
        return;
      }

      state.formatterHistory.forEach(group => {
        const groupEl = document.createElement('div');
        groupEl.className = 'formatter-history-group';
        const header = document.createElement('div');
        header.className = 'formatter-history-header';
        const title = document.createElement('h4');
        title.textContent = new Date(group.dateYMD).toLocaleDateString('pt-BR');
        header.appendChild(title);
        groupEl.appendChild(header);

        group.entries.forEach(entry => {
          const entryEl = document.createElement('div');
          entryEl.className = 'formatter-history-entry';
          const meta = document.createElement('div');
          meta.className = 'entry-meta';
          const dateSpan = document.createElement('span');
          dateSpan.textContent = `Criado em ${new Date(entry.createdAt).toLocaleString('pt-BR')}`;
          const countersSpan = document.createElement('span');
          countersSpan.textContent = `Execu√ß√£o: ${entry.counters.green} ¬∑ Necessitam: ${entry.counters.red} ¬∑ Total: ${entry.counters.blue}`;
          const daysSpan = document.createElement('span');
          daysSpan.textContent = `Dias: ${entry.days.join(', ')}`;
          meta.appendChild(dateSpan);
          meta.appendChild(countersSpan);
          meta.appendChild(daysSpan);

          const pre = document.createElement('pre');
          pre.textContent = entry.text;

          const buttons = document.createElement('div');
          buttons.className = 'btn-row';
          const copy = document.createElement('button');
          copy.className = 'btn btn-outline';
          copy.textContent = 'Copiar';
          copy.addEventListener('click', () => {
            navigator.clipboard.writeText(entry.text).then(() => {
              alert('Lista copiada.');
            });
          });

          const remove = document.createElement('button');
          remove.className = 'btn btn-danger';
          remove.textContent = 'Excluir';
          remove.addEventListener('click', () => {
            if (confirm('Deseja remover este registro do hist√≥rico?')) {
              const groupRef = state.formatterHistory.find(g => g.dateYMD === group.dateYMD);
              if (!groupRef) return;
              groupRef.entries = groupRef.entries.filter(e => e.id !== entry.id);
              if (!groupRef.entries.length) {
                state.formatterHistory = state.formatterHistory.filter(g => g.dateYMD !== group.dateYMD);
              }
              saveAll();
              renderFormatterHistory();
            }
          });

          buttons.appendChild(copy);
          buttons.appendChild(remove);

          entryEl.appendChild(meta);
          entryEl.appendChild(pre);
          entryEl.appendChild(buttons);
          groupEl.appendChild(entryEl);
        });

        formatterHistoryEl.appendChild(groupEl);
      });
    }

    document.getElementById('btn-format').addEventListener('click', () => {
      const input = document.getElementById('formatter-input').value.trim();
      if (!input) {
        alert('Cole uma lista antes de formatar.');
        return;
      }
      const result = parseFormatter(input);
      if (!result) {
        alert('N√£o foi poss√≠vel interpretar a lista fornecida.');
        return;
      }
      renderFormatterOutput(result);
      addFormatterHistoryEntry(result);
      saveAll();
    });

    document.getElementById('btn-copy-output').addEventListener('click', () => {
      const text = formatterOutputEl.textContent.trim();
      if (!text) {
        alert('Nada para copiar.');
        return;
      }
      navigator.clipboard.writeText(text).then(() => alert('Lista formatada copiada.'));
    });

    document.getElementById('btn-export-txt').addEventListener('click', () => {
      const text = formatterOutputEl.textContent.trim();
      if (!text) {
        alert('Nada para exportar.');
        return;
      }
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      downloadFile('noc_formatter_saida.txt', blob);
    });

    document.getElementById('btn-clear-formatter').addEventListener('click', () => {
      document.getElementById('formatter-input').value = '';
      renderFormatterOutput(null);
    });

    function normalizeCompany(code) {
      if (!code) return '';
      const normalized = code
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toUpperCase()
        .replace(/[^A-Z]/g, '')
        .slice(0, 3);
      if (normalized === 'EMG') return 'EMR';
      return normalized;
    }

    function parseLineAssumingDate(line, defaultDateYMD) {
      const normalizedLine = line
        .replace(/[‚Äì‚Äî]/g, '-')
        .replace(/(\d{2})h(\d{2})/gi, '$1:$2')
        .replace(/\[(\d{2}:\d{2})\]/g, '$1')
        .replace(/(\d{2}:\d{2})h/gi, '$1');

      const timeMatch = normalizedLine.match(/(\d{2}):(\d{2})/);
      const hour = timeMatch ? parseInt(timeMatch[1], 10) : 0;
      const minute = timeMatch ? parseInt(timeMatch[2], 10) : 0;
      const time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;

      let clean = normalizedLine;
      if (timeMatch) {
        clean = clean.replace(timeMatch[0], '').replace(/^-/, '').trim();
      }

      const segments = clean.split(/\s*-\s*/).map(seg => seg.trim()).filter(Boolean);
      let servico = '';
      let empresaSegment = '';
      let rest = '';

      if (segments.length >= 3) {
        servico = segments[0];
        empresaSegment = segments[1];
        rest = segments.slice(2).join(' - ');
      } else {
        const serviceMatch = clean.match(/\b([A-Z][A-Z0-9]{3,})\b/);
        servico = serviceMatch ? serviceMatch[1] : 'SERVICO';
        const empresaMatch = clean.match(/\b([A-Z]{3})\b/);
        empresaSegment = empresaMatch ? empresaMatch[1] : 'EMP';
        rest = clean.replace(servico, '').replace(empresaSegment, '').trim();
      }

      servico = servico
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toUpperCase()
        .replace(/[^A-Z0-9]/g, '');
      if (servico.length < 4) {
        servico = 'SERVICO';
      }
      const empresas = empresaSegment.split(',').map(e => normalizeCompany(e.trim())).filter(Boolean);
      const atuacaoNorm = norm(rest);
      const atuacao = atuacaoNorm.includes('necessario reinicio') || atuacaoNorm.includes('necessario atuacao') || atuacaoNorm.includes('necessario execucao') || atuacaoNorm.includes('necessario a execucao')
        ? 'SIM'
        : 'N√ÉO';

      const [year, month, day] = defaultDateYMD.split('-').map(Number);
      const iso = toISO8601Z(year, month, day, hour, minute);

      if (!empresas.length) {
        empresas.push('EMP');
      }

      return empresas.map(empresa => ({
        datahora: iso,
        servico: servico,
        empresa,
        observacao: '',
        atuacao
      }));
    }

    function incrementDateYMD(ymd) {
      const [y, m, d] = ymd.split('-').map(Number);
      const date = new Date(y, m - 1, d + 1);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    function parseTextByDateHeaders(raw, fallbackDateYMD) {
      const lines = raw.split(/\r?\n/);
      const byDay = {};
      const all = [];
      let currentDateYMD = fallbackDateYMD || todayYMD();
      let lastMinutes = null;

      lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        if (/\(\s*Novos registros abaixo\s*\)/i.test(trimmed)) return;
        const headerMatch = trimmed.match(/^\|?\s*(\d{2})\/(\d{2})\/(\d{4})\s*$/);
        if (headerMatch) {
          currentDateYMD = `${headerMatch[3]}-${headerMatch[2]}-${headerMatch[1]}`;
          lastMinutes = null;
          return;
        }

        const normalizedLine = trimmed
          .replace(/[‚Äì‚Äî]/g, '-')
          .replace(/(\d{2})h(\d{2})/gi, '$1:$2')
          .replace(/\[(\d{2}:\d{2})\]/g, '$1')
          .replace(/(\d{2}:\d{2})h/gi, '$1');
        const timeMatch = normalizedLine.match(/(\d{2}):(\d{2})/);
        const minutes = timeMatch ? parseInt(timeMatch[1], 10) * 60 + parseInt(timeMatch[2], 10) : 0;

        if (lastMinutes !== null && minutes < lastMinutes && lastMinutes >= 22 * 60 && minutes <= 6 * 60) {
          currentDateYMD = incrementDateYMD(currentDateYMD);
        }
        lastMinutes = minutes;

      const records = parseLineAssumingDate(trimmed, currentDateYMD);
      records.forEach(record => {
        const entry = {
          datahora: record.datahora,
          servico: record.servico,
          empresa: record.empresa,
          observacao: '',
          atuacao: record.atuacao
        };
        all.push(entry);
        if (!byDay[currentDateYMD]) byDay[currentDateYMD] = [];
        byDay[currentDateYMD].push({ ...entry });
      });
      });

      return { byDay, all };
    }

    function renderTable() {
      recordsBody.innerHTML = '';
      const filtered = state.records.filter(record => {
        return (!state.filters.datahora || record.datahora === state.filters.datahora)
          && (!state.filters.servico || record.servico === state.filters.servico)
          && (!state.filters.empresa || record.empresa === state.filters.empresa)
          && (!state.filters.observacao || record.observacao === state.filters.observacao)
          && (!state.filters.atuacao || record.atuacao === state.filters.atuacao);
      });

      filtered.forEach(record => {
        const tr = document.createElement('tr');
        const columns = ['datahora', 'servico', 'empresa', 'observacao', 'atuacao'];
        columns.forEach(col => {
          const td = document.createElement('td');
          td.dataset.col = col;
          if (col === 'observacao') {
            td.contentEditable = true;
            td.spellcheck = false;
            td.textContent = record[col] || '';
            td.addEventListener('blur', () => {
              const idx = state.records.indexOf(record);
              if (idx >= 0) {
                state.records[idx][col] = td.textContent.trim();
                saveAll();
              }
            });
            td.addEventListener('keydown', event => {
              if (event.key === 'Enter') {
                event.preventDefault();
                td.blur();
              }
            });
          } else if (col === 'atuacao') {
            td.dataset.value = record[col];
            td.textContent = record[col];
          } else {
            td.textContent = record[col];
          }
          tr.appendChild(td);
        });
        recordsBody.appendChild(tr);
      });
    }

    function renderHistory() {
      historyList.innerHTML = '';
      if (!state.history.length) {
        const empty = document.createElement('p');
        empty.textContent = 'Sem hist√≥rico dispon√≠vel.';
        historyList.appendChild(empty);
        return;
      }

      state.history
        .slice()
        .sort((a, b) => new Date(b.createdAtISO) - new Date(a.createdAtISO))
        .forEach(batch => {
          const item = document.createElement('div');
          item.className = 'history-item';
          const header = document.createElement('div');
          header.className = 'history-header';
          const left = document.createElement('div');
          left.style.display = 'flex';
          left.style.flexDirection = 'column';
          const title = document.createElement('strong');
          title.textContent = new Date(batch.dateYYYYMMDD).toLocaleDateString('pt-BR');
          const subtitle = document.createElement('span');
          subtitle.style.fontSize = '0.8rem';
          subtitle.style.opacity = '0.8';
          subtitle.textContent = `Registrado em ${new Date(batch.createdAtISO).toLocaleString('pt-BR')} ¬∑ ${batch.items.length} itens`;
          left.appendChild(title);
          left.appendChild(subtitle);
          header.appendChild(left);
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = 'Ver registros';
          header.appendChild(badge);
          item.appendChild(header);

          const content = document.createElement('div');
          content.className = 'history-content';

          const actions = document.createElement('div');
          actions.className = 'btn-row';

          const exportCsv = document.createElement('button');
          exportCsv.className = 'btn btn-outline';
          exportCsv.textContent = 'Exportar CSV';
          exportCsv.addEventListener('click', evt => {
            evt.stopPropagation();
            exportCSV(batch.items);
          });

          const exportXlsx = document.createElement('button');
          exportXlsx.className = 'btn btn-outline';
          exportXlsx.textContent = 'Exportar XLSX';
          exportXlsx.addEventListener('click', evt => {
            evt.stopPropagation();
            exportXLSX(batch.items);
          });

          const exportTxt = document.createElement('button');
          exportTxt.className = 'btn btn-outline';
          exportTxt.textContent = 'Exportar TXT';
          exportTxt.addEventListener('click', evt => {
            evt.stopPropagation();
            exportTXT(batch.items);
          });

          const remove = document.createElement('button');
          remove.className = 'btn btn-danger';
          remove.textContent = 'Excluir dia';
          remove.addEventListener('click', evt => {
            evt.stopPropagation();
            if (confirm('Excluir este dia do hist√≥rico?')) {
              state.history = state.history.filter(h => h.id !== batch.id);
              saveAll();
              renderHistory();
            }
          });

          actions.appendChild(exportCsv);
          actions.appendChild(exportXlsx);
          actions.appendChild(exportTxt);
          actions.appendChild(remove);

          const list = document.createElement('div');
          list.style.display = 'grid';
          list.style.gap = '6px';
          list.style.fontSize = '0.85rem';
          batch.items.forEach(itemRecord => {
            const line = document.createElement('div');
            line.textContent = `${itemRecord.datahora} ¬∑ ${itemRecord.servico} ¬∑ ${itemRecord.empresa} ¬∑ ${itemRecord.atuacao}`;
            list.appendChild(line);
          });

          content.appendChild(actions);
          content.appendChild(list);
          item.appendChild(content);

          header.addEventListener('click', () => {
            item.classList.toggle('open');
            badge.textContent = item.classList.contains('open') ? 'Ocultar' : 'Ver registros';
          });

          historyList.appendChild(item);
        });
    }

    document.getElementById('btn-add-records').addEventListener('click', () => {
      const raw = document.getElementById('panel-input').value.trim();
      if (!raw) {
        alert('Informe os registros para adicionar.');
        return;
      }
      const dateInput = document.getElementById('panel-date').value;
      const fallbackDate = dateInput || todayYMD();
      const { byDay, all } = parseTextByDateHeaders(raw, fallbackDate);
      if (!all.length) {
        alert('Nenhum registro v√°lido encontrado.');
        return;
      }
      state.records = state.records.concat(all.map(item => ({ ...item })));
      Object.entries(byDay).forEach(([dateYMD, items]) => {
        addHistoryBatch(items, dateYMD);
      });
      document.getElementById('panel-input').value = '';
      saveAll();
      renderTable();
      renderHistory();
      alert(`${all.length} registros adicionados.`);
    });

    document.getElementById('btn-clear-table').addEventListener('click', () => {
      if (!state.records.length) {
        alert('Tabela j√° est√° vazia.');
        return;
      }
      if (confirm('Deseja apagar todos os registros atuais? Esta a√ß√£o n√£o remove o hist√≥rico.')) {
        state.records = [];
        saveAll();
        renderTable();
      }
    });

    document.getElementById('btn-clear-all').addEventListener('click', () => {
      if (confirm('Limpar tabela e hist√≥rico? Esta a√ß√£o √© irrevers√≠vel.')) {
        state.records = [];
        state.history = [];
        state.formatterHistory = [];
        saveAll();
        renderTable();
        renderHistory();
        renderFormatterHistory();
        renderFormatterOutput(null);
      }
    });

    document.getElementById('btn-clear-filters').addEventListener('click', () => {
      Object.keys(state.filters).forEach(key => (state.filters[key] = null));
      renderTable();
    });

    function mapForExport(items) {
      return items.map(item => ({
        DataHora: item.datahora,
        Servico: item.servico,
        Empresa: item.empresa,
        Observacao: item.observacao || '',
        Atuacao: item.atuacao
      }));
    }

    function exportCSV(items) {
      const source = items || state.records;
      if (!source.length) {
        alert('Sem registros para exportar.');
        return;
      }
      const mapped = mapForExport(source);
      const header = Object.keys(mapped[0]);
      const lines = [header.join(',')];
      mapped.forEach(row => {
        const values = header.map(key => {
          const value = String(row[key] ?? '').replace(/"/g, '""');
          return `"${value}"`;
        });
        lines.push(values.join(','));
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8' });
      downloadFile('carga_diario_de_bordo.csv', blob);
    }

    function exportTXT(items) {
      const source = items || state.records;
      if (!source.length) {
        alert('Sem registros para exportar.');
        return;
      }
      const mapped = mapForExport(source);
      const header = Object.keys(mapped[0]);
      const lines = [header.join('\t')];
      mapped.forEach(row => {
        const values = header.map(key => String(row[key] ?? ''));
        lines.push(values.join('\t'));
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
      downloadFile('carga_diario_de_bordo.txt', blob);
    }

    function exportXLSX(items) {
      const source = items || state.records;
      if (!source.length) {
        alert('Sem registros para exportar.');
        return;
      }
      const mapped = mapForExport(source);
      const worksheet = XLSX.utils.json_to_sheet(mapped, { header: ['DataHora', 'Servico', 'Empresa', 'Observacao', 'Atuacao'] });
      worksheet['!autofilter'] = { ref: `A1:E${mapped.length + 1}` };
      worksheet['!cols'] = [
        { wch: 24 },
        { wch: 20 },
        { wch: 10 },
        { wch: 60 },
        { wch: 8 }
      ];
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Checklist');
      try {
        XLSX.writeFile(workbook, 'carga_diario_de_bordo.xlsx');
      } catch (error) {
        const arrayBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([arrayBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        downloadFile('carga_diario_de_bordo.xlsx', blob);
      }
    }

    document.getElementById('btn-export-csv').addEventListener('click', () => exportCSV());
    document.getElementById('btn-export-xlsx').addEventListener('click', () => exportXLSX());
    document.getElementById('btn-export-txt-table').addEventListener('click', () => exportTXT());

    function addHistoryBatch(items, dateYMD) {
      const batch = {
        id: crypto.randomUUID ? crypto.randomUUID() : `batch-${Date.now()}-${Math.random()}`,
        dateYYYYMMDD: dateYMD,
        createdAtISO: new Date().toISOString().replace(/\.\d{3}Z$/, 'Z'),
        items: items.map(item => ({ ...item }))
      };
      state.history.push(batch);
      saveAll();
    }

    function createFilterMenu(column, anchor) {
      document.querySelectorAll('.filter-menu').forEach(menu => menu.remove());
      const menu = document.createElement('div');
      menu.className = 'filter-menu';

      const uniqueValues = Array.from(new Set(state.records.map(record => record[column]).filter(value => value !== undefined && value !== '')));
      uniqueValues.sort();

      if (!uniqueValues.length) {
        const empty = document.createElement('div');
        empty.textContent = 'Sem valores dispon√≠veis.';
        menu.appendChild(empty);
      } else {
        uniqueValues.forEach(value => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = value;
          btn.addEventListener('click', () => {
            state.filters[column] = value;
            menu.remove();
            renderTable();
          });
          menu.appendChild(btn);
        });
      }

      const clearBtn = document.createElement('button');
      clearBtn.type = 'button';
      clearBtn.textContent = 'Limpar';
      clearBtn.addEventListener('click', () => {
        state.filters[column] = null;
        menu.remove();
        renderTable();
      });
      menu.appendChild(clearBtn);

      document.body.appendChild(menu);
      const rect = anchor.getBoundingClientRect();
      menu.style.top = `${rect.bottom + window.scrollY + 8}px`;
      menu.style.left = `${rect.left + window.scrollX}px`;

      const closeHandler = (event) => {
        if (!menu.contains(event.target) && event.target !== anchor) {
          menu.remove();
          document.removeEventListener('click', closeHandler);
        }
      };
      setTimeout(() => document.addEventListener('click', closeHandler), 0);
    }

    document.querySelectorAll('.filter-trigger').forEach(trigger => {
      trigger.addEventListener('click', event => {
        event.stopPropagation();
        const column = trigger.dataset.column;
        createFilterMenu(column, trigger);
      });
    });

    document.getElementById('panel-date').value = todayYMD();

    loadAll();
    applyTheme(state.theme);
    renderTable();
    renderHistory();
    renderFormatterHistory();

    if (state.formatterHistory.length) {
      const lastGroup = state.formatterHistory[0];
      if (lastGroup && lastGroup.entries && lastGroup.entries.length) {
        renderFormatterOutput({
          text: lastGroup.entries[0].text,
          counters: lastGroup.entries[0].counters,
          days: lastGroup.entries[0].days
        });
      }
    }

    function extractDateTimeFromPipe(text) {
      const pattern = /\|(\s*\d{2}\/\d{2}\/\d{4})\s*(\d{2}:\d{2})?/g;
      const matches = [];
      let match;
      while ((match = pattern.exec(text)) !== null) {
        const date = match[1].trim();
        const time = match[2] ? match[2].trim() : '';
        matches.push(`${date} ${time}`.trim());
      }
      return matches;
    }
  </script>
</body>
</html>
