<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOC Formatter</title>
  <link rel="icon" type="image/svg+xml" href="lib/logo.svg" sizes="any">

  <!-- Biblioteca XLSX via CDN -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>

  <style>
    :root {
      color-scheme: dark;
      --bg: #0b1120;
      --surface: #1f2937;
      --surface-strong: rgba(15, 23, 42, 0.9);
      --border: #334155;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --accent-hover: #0ea5e9;
      --danger: #f97316;
      --bg-gradient: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), var(--bg));
      --matrix-overlay: none;
      font-size: 16px;
    }

    body.theme-default {
      color-scheme: dark;
      --bg: #0b1120;
      --surface: #1f2937;
      --surface-strong: rgba(15, 23, 42, 0.9);
      --border: #334155;
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --accent-hover: #0ea5e9;
      --danger: #f97316;
      --bg-gradient: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), var(--bg));
      --matrix-overlay: none;
    }

    body.theme-light {
      color-scheme: light;
      --bg: #f8fafc;
      --surface: #ffffff;
      --surface-strong: rgba(255, 255, 255, 0.9);
      --border: #d4d4d8;
      --text: #0f172a;
      --text-muted: #475569;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --danger: #e11d48;
      --bg-gradient: radial-gradient(circle at top, rgba(226, 232, 240, 0.9), var(--bg));
      --matrix-overlay: none;
    }

    body.theme-hacker {
      color-scheme: dark;
      --bg: #020c0a;
      --surface: rgba(4, 15, 12, 0.85);
      --surface-strong: rgba(4, 15, 12, 0.95);
      --border: #134e4a;
      --text: #d1fae5;
      --text-muted: #34d399;
      --accent: #22c55e;
      --accent-hover: #16a34a;
      --danger: #f97316;
      --bg-gradient: radial-gradient(circle at 20% 20%, rgba(15, 118, 110, 0.35), #020c0a 65%);
      --matrix-overlay: repeating-linear-gradient(
        180deg,
        rgba(34, 197, 94, 0.08) 0,
        rgba(34, 197, 94, 0.08) 2px,
        transparent 2px,
        transparent 4px
      );
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg-gradient);
      color: var(--text);
      font-family: "Segoe UI", "Helvetica Neue", Roboto, sans-serif;
      line-height: 1.5;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: var(--matrix-overlay);
      background-size: 100% 24px;
      opacity: 0.5;
      pointer-events: none;
      animation: matrixFall 18s linear infinite;
      mix-blend-mode: screen;
      z-index: 0;
    }

    h1 {
      font-size: clamp(1.5rem, 2vw + 1rem, 2.5rem);
      margin: 0;
      text-align: center;
      letter-spacing: 0.04em;
    }

    .subtitle {
      text-align: center;
      color: var(--text-muted);
      margin: 0;
    }

    .wrapper {
      position: relative;
      max-width: 1080px;
      margin: 0 auto;
      padding: 2.5rem 1.5rem 3rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      z-index: 1;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0.85rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
      position: sticky;
      top: 1rem;
      backdrop-filter: blur(6px);
      z-index: 2;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      align-items: center;
      text-align: center;
      flex: 1;
    }

    .brand-logo {
      height: 48px;
      width: auto;
      margin-bottom: 0.15rem;
    }

    .menu-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 46px;
      height: 46px;
      border-radius: 0.9rem;
      border: 1px solid var(--border);
      background: linear-gradient(145deg, rgba(56, 189, 248, 0.18), rgba(14, 165, 233, 0.12));
      color: var(--text);
      font-size: 1.25rem;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    .menu-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(14, 165, 233, 0.3);
    }

    .menu-toggle:active {
      transform: translateY(1px);
    }

    .menu-drawer {
      position: fixed;
      inset: 0 auto 0 0;
      width: min(380px, 90vw);
      background: var(--surface-strong);
      border-right: 1px solid var(--border);
      box-shadow: 14px 0 28px rgba(0, 0, 0, 0.18);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1.25rem 1.25rem 1.5rem;
      z-index: 5;
      overflow-y: auto;
      backdrop-filter: none;
    }

    .menu-drawer.open {
      transform: translateX(0);
    }

    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: none;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 4;
    }

    .menu-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .menu-title {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: 0.02em;
    }

    .menu-close {
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      border-radius: 0.75rem;
      width: 42px;
      height: 42px;
      cursor: pointer;
    }

    .menu-section {
      border: 1px solid var(--border);
      border-radius: 0.85rem;
      padding: 1rem;
      background: var(--surface);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .menu-tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5rem;
      margin: 0.35rem 0 0.75rem;
    }

    .menu-tab {
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      padding: 0.65rem 0.85rem;
      border-radius: 0.75rem;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.01em;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
    }

    .menu-tab.active {
      border-color: var(--accent);
      box-shadow: 0 10px 22px rgba(14, 165, 233, 0.25);
      transform: translateY(-1px);
    }

    .tab-panel {
      display: none;
      flex-direction: column;
      gap: 0.85rem;
    }

    .tab-panel.active {
      display: flex;
    }

    .menu-section h2 {
      margin: 0 0 0.35rem;
      font-size: 1rem;
    }

    .menu-section p {
      margin: 0 0 0.85rem;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .theme-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.5rem;
    }

    .theme-button {
      border: 1px solid var(--border);
      background: var(--surface-strong);
      color: var(--text);
      border-radius: 0.85rem;
      padding: 0.75rem 0.9rem;
      cursor: pointer;
      display: grid;
      gap: 0.15rem;
      transition: border-color 0.2s ease, transform 0.12s ease;
    }

    .theme-button span {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .theme-button.active {
      border-color: var(--accent);
      box-shadow: 0 10px 20px rgba(14, 165, 233, 0.3);
      transform: translateY(-1px);
    }

    .catalog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.65rem;
      margin-bottom: 0.5rem;
    }

    .catalog-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .catalog-list {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      margin-top: 0.75rem;
    }

    .catalog-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 0.65rem 0.75rem;
      background: var(--surface-strong);
      gap: 0.75rem;
    }

    .catalog-texts {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .catalog-type {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(56, 189, 248, 0.12);
      color: var(--accent);
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      border: 1px solid var(--border);
    }

    .catalog-empty {
      color: var(--text-muted);
      text-align: center;
      font-size: 0.95rem;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    textarea {
      width: 100%;
      min-height: 220px;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      resize: vertical;
      font-family: "Fira Code", "JetBrains Mono", "Consolas", monospace;
      font-size: 0.95rem;
      line-height: 1.6;
      box-shadow: inset 0 0 0 999px rgba(8, 47, 73, 0.08);
    }

    pre {
      width: 100%;
      min-height: 220px;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-family: "Fira Code", "JetBrains Mono", "Consolas", monospace;
      font-size: 0.95rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      margin: 0;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
    }

    button {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.75rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      color: var(--text);
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.85), rgba(14, 165, 233, 0.95));
      box-shadow: 0 10px 25px rgba(8, 145, 178, 0.35);
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(14, 165, 233, 0.4);
      background: linear-gradient(135deg, var(--accent-hover), rgba(56, 189, 248, 0.95));
    }

    button:active {
      transform: translateY(1px);
    }

    button.secondary {
      background: linear-gradient(135deg, rgba(129, 140, 248, 0.75), rgba(59, 130, 246, 0.85));
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.35);
    }

    .small-button {
      padding: 0.45rem 0.85rem;
      border-radius: 0.65rem;
      font-size: 0.9rem;
    }

    button.ghost {
      background: linear-gradient(135deg, rgba(100, 116, 139, 0.7), rgba(71, 85, 105, 0.8));
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.35);
    }

    button.danger {
      background: linear-gradient(135deg, rgba(251, 146, 60, 0.85), rgba(249, 115, 22, 0.9));
      box-shadow: 0 10px 24px rgba(249, 115, 22, 0.35);
    }

    .panel {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .menu-note {
      text-align: center;
      color: var(--text-muted);
      background: var(--surface);
      border: 1px dashed var(--border);
      border-radius: 0.85rem;
      padding: 0.9rem 1rem;
    }

    .credits {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      margin: 0 auto 1.25rem;
      padding: 0 1.5rem;
    }

    @media (max-width: 720px) {
      .wrapper {
        padding: 2rem 1rem 2.5rem;
      }

      .topbar {
        position: sticky;
        top: 0.75rem;
      }

      textarea,
      pre {
        min-height: 180px;
      }
    }

    @keyframes matrixFall {
      0% {
        background-position-y: 0;
      }
      100% {
        background-position-y: 200px;
      }
    }
  </style>
</head>
<body>
  <div id="menuOverlay" class="menu-overlay" onclick="fecharMenu()"></div>
  <aside id="menuDrawer" class="menu-drawer" aria-label="Menu lateral">
    <div class="menu-header">
      <h2 class="menu-title">Painel</h2>
      <button class="menu-close" onclick="fecharMenu()" aria-label="Fechar menu">‚úï</button>
    </div>
    <div class="menu-tabs" role="tablist">
      <button class="menu-tab active" data-tab="config" onclick="ativarAba('config')" role="tab">Configura√ß√µes</button>
      <button class="menu-tab" data-tab="rules" onclick="ativarAba('rules')" role="tab">Regras</button>
    </div>

    <div class="tab-panel active" data-tab-panel="config" role="tabpanel">
      <section class="menu-section">
        <h2>Temas</h2>
        <p>Escolha o visual da aplica√ß√£o. A sele√ß√£o ser√° lembrada no pr√≥ximo acesso.</p>
        <div class="theme-options">
          <button class="theme-button active" data-theme="default" onclick="selecionarTema('default')">
            <strong>Padr√£o</strong>
            <span>Gradiente escuro</span>
          </button>
          <button class="theme-button" data-theme="light" onclick="selecionarTema('light')">
            <strong>Claro</strong>
            <span>Interfaces leves</span>
          </button>
          <button class="theme-button" data-theme="hacker" onclick="selecionarTema('hacker')">
            <strong>Hacker</strong>
            <span>Preto e verde</span>
          </button>
        </div>
      </section>

      <section class="menu-section">
        <div class="menu-section-header">
          <h2>Cat√°logo</h2>
          <p>Cadastre palavras-chave para for√ßar a identifica√ß√£o de servi√ßos e outros itens.</p>
        </div>
        <div class="catalog-grid">
          <div>
            <label for="catalogType">Tipo</label>
            <select id="catalogType">
              <option value="Servi√ßo">Servi√ßo</option>
              <option value="Empresa">Empresa</option>
              <option value="Observa√ß√£o">Observa√ß√£o</option>
            </select>
          </div>
          <div>
            <label for="catalogText">Texto a identificar</label>
            <input id="catalogText" type="text" placeholder="Ex.: Servi√ßo" />
          </div>
        </div>
        <div class="catalog-actions">
          <button type="button" class="secondary" onclick="adicionarEntradaCatalogo()">Adicionar ao cat√°logo</button>
          <button type="button" class="ghost" onclick="limparCamposCatalogo()">Limpar</button>
        </div>
        <div id="catalogList" class="catalog-list"></div>
      </section>
    </div>

    <div class="tab-panel" data-tab-panel="rules" role="tabpanel">
      <section class="menu-section">
        <div class="menu-section-header">
          <h2>Regras personalizadas</h2>
          <p>Adicione, edite ou remova as regras que complementam os formatos padr√£o.</p>
        </div>
        <div class="rules-grid">
          <div>
            <label for="ruleMatch">Texto a detectar</label>
            <input id="ruleMatch" type="text" placeholder="Ex.: Necess√°rio atua√ß√£o" />
          </div>
          <div>
            <label for="ruleValue">Substitui√ß√£o</label>
            <input id="ruleValue" type="text" placeholder="Ex.: SIM" />
          </div>
        </div>
        <div class="rules-actions">
          <button type="button" class="secondary" onclick="salvarRegra()" id="ruleSaveButton">Salvar regra</button>
          <button type="button" class="ghost" onclick="cancelarEdicao()">Cancelar edi√ß√£o</button>
        </div>
        <div id="rulesList" class="rules-list"></div>
      </section>
    </div>
  </aside>

  <main class="wrapper">
    <div class="topbar">
      <button class="menu-toggle" id="menuButton" aria-label="Abrir menu" onclick="abrirMenu()">‚ò∞</button>
      <div class="brand">
        <img class="brand-logo" src="lib/noc-logo.svg" alt="Logotipo do NOC Formatter" />
        <h1>NOC Formatter</h1>
        <p class="subtitle">Formate o relat√≥rio di√°rio com poucos cliques, totalmente offline.</p>
      </div>
    </div>

    <p class="menu-note">Acesse o menu (‚ò∞) para gerenciar temas, cat√°logo e regras personalizadas.</p>

    <section class="panel">
      <label for="in">Entrada bruta</label>
      <textarea id="in" placeholder="Cole aqui os registros brutos do plant√£o..."></textarea>
    </section>

    <div class="actions">
      <button type="button" onclick="formatar()">Formatar</button>
      <button type="button" class="secondary" onclick="copiar()">Copiar Lista</button>
      <button type="button" class="ghost" onclick="limpar()">Limpar Lista</button>
      <button type="button" class="danger" onclick="exportarXLSX()">Exportar em XLSX</button>
    </div>

    <section class="panel">
      <label for="out">Sa√≠da formatada</label>
      <pre id="out"></pre>
    </section>
  </main>

  <p class="credits">Criado por Onofre Augusto | NOC</p>

  <script>
    const THEME_KEY = 'nocFormatterTheme';
    const dateRegex = /^\d{1,2}\/\d{1,2}\/\d{4}$/;
    const eventRegex =
      /^(\d{1,2}[:h]\d{2}h?)\s*[-‚Äì]\s*([A-Za-z\d-]{4,})\s*[-‚Äì]\s*([A-Za-z]{3}(?:\s*,\s*[A-Za-z]{3})*)\s*[-‚Äì]\s*(.+)$/;
    const STORAGE_KEY = 'nocFormatterRules';
    const CATALOG_KEY = 'nocFormatterCatalog';
    const defaultRules = [
      { match: 'Sem atuacao', value: 'N√ÉO' },
      { match: 'Servico em execucao', value: 'N√ÉO' },
      { match: 'Necessario_execucao_do_servico', value: 'SIM' },
      { match: 'Necessario atuacao', value: 'SIM' },
      { match: 'Necessario a execucao', value: 'SIM' },
      { match: 'Necessario a execucao do servico', value: 'SIM' }
    ];
    let formattedRows = [];
    let userRules = [];
    let catalogEntries = [];
    let editingIndex = null;

    document.addEventListener('DOMContentLoaded', () => {
      restaurarTema();
      carregarRegras();
      renderizarRegras();
      carregarCatalogo();
      renderizarCatalogo();
      atualizarBotoesTema();
      ativarAba('config');
    });

    function abrirMenu() {
      document.getElementById('menuDrawer').classList.add('open');
      document.getElementById('menuOverlay').classList.add('visible');
    }

    function fecharMenu() {
      document.getElementById('menuDrawer').classList.remove('open');
      document.getElementById('menuOverlay').classList.remove('visible');
    }

    function selecionarTema(theme) {
      aplicarTema(theme);
      fecharMenu();
    }

    function ativarAba(tab) {
      const tabs = document.querySelectorAll('.menu-tab');
      const panels = document.querySelectorAll('.tab-panel');

      tabs.forEach((button) => {
        const isActive = button.getAttribute('data-tab') === tab;
        button.classList.toggle('active', isActive);
      });

      panels.forEach((panel) => {
        const isActive = panel.getAttribute('data-tab-panel') === tab;
        panel.classList.toggle('active', isActive);
      });
    }

    function aplicarTema(theme) {
      const themes = ['default', 'light', 'hacker'];
      if (!themes.includes(theme)) {
        theme = 'default';
      }
      document.body.classList.remove(...themes.map((t) => `theme-${t}`));
      document.body.classList.add(`theme-${theme}`);
      document.documentElement.style.colorScheme = theme === 'light' ? 'light' : 'dark';
      localStorage.setItem(THEME_KEY, theme);
      atualizarBotoesTema(theme);
    }

    function atualizarBotoesTema(activeTheme = localStorage.getItem(THEME_KEY) || 'default') {
      const buttons = document.querySelectorAll('.theme-button');
      buttons.forEach((button) => {
        const theme = button.getAttribute('data-theme');
        button.classList.toggle('active', theme === activeTheme);
      });
    }

    function restaurarTema() {
      const saved = localStorage.getItem(THEME_KEY) || 'default';
      aplicarTema(saved);
    }

    function formatar() {
      const input = document.getElementById('in').value.split(/\r?\n/);
      const output = [];
      let currentDate = '';
      let lastTimeMinutes = null;
      let lastHour = null;
      formattedRows = [];

      function registrarEvento({ time, service, companies, status }) {
        const [hour, minutes] = time.split(':').map(Number);
        const currentMinutes = hour * 60 + minutes;

        if (currentDate && lastTimeMinutes !== null) {
          if (currentMinutes < lastTimeMinutes && lastHour !== null && lastHour >= 18 && hour <= 6) {
            currentDate = incDate(currentDate);
            output.push(currentDate);
            lastTimeMinutes = null;
            lastHour = null;
          }
        }

        const observacao = applyRulesToText('');
        const dataHora = currentDate && time ? `${currentDate}T${time}:00Z` : '';

        for (const company of companies.length ? companies : ['']) {
          const formattedCompany = company ? applyRulesToText(company).toUpperCase() : '';
          output.push(`${time} - ${service} - ${formattedCompany} - ${status}`);
          if (currentDate) {
            formattedRows.push({
              date: currentDate,
              time,
              dataHora,
              service,
              company: formattedCompany,
              observacao,
              atuacao: status,
              status
            });
          }
        }

        lastTimeMinutes = currentMinutes;
        lastHour = hour;
      }

      for (const rawLine of input) {
        const line = replaceUnicodeDashes(rawLine.trim());
        if (!line) {
          continue;
        }

        if (dateRegex.test(line)) {
          currentDate = line;
          lastTimeMinutes = null;
          lastHour = null;
          output.push(line);
          continue;
        }

        const match = line.match(eventRegex);
        if (match) {
          const [, rawTime, serviceGroup, companiesGroup, statusGroup] = match;
          const rawService = serviceGroup.trim();
          const rawCompanies = companiesGroup.trim();
          const rawStatus = statusGroup.trim();
          const time = normalizeTime(rawTime);
          const [hour, minutes] = time.split(':').map(Number);
          const currentMinutes = hour * 60 + minutes;

          if (currentDate && lastTimeMinutes !== null) {
            if (currentMinutes < lastTimeMinutes && lastHour !== null && lastHour >= 18 && hour <= 6) {
              currentDate = incDate(currentDate);
              output.push(currentDate);
              lastTimeMinutes = null;
              lastHour = null;
            }
          }

          const serviceCatalogMatch = encontrarServicoNoCatalogo(rawService);
          const serviceBase = serviceCatalogMatch?.text || rawService;
          const service = applyRulesToText(serviceBase).toUpperCase();
          const companies = rawCompanies
            .split(/\s*,\s*/)
            .map((c) => applyRulesToText(c).toUpperCase())
            .filter(Boolean);
          const status = normalizeStatus(rawStatus);
          const dataHora = currentDate && time ? `${currentDate}T${time}:00Z` : '';
          const observacao = applyRulesToText('');
          const atuacao = status || '';

          registrarEvento({ time, service, companies, status: atuacao });
          continue;
        }

        const catalogClassification = tentarClassificarLinhaPorCatalogo(line);
        if (catalogClassification) {
          registrarEvento(catalogClassification);
          continue;
        }

        output.push(applyRulesToText(line));
      }

      document.getElementById('out').textContent = output.join('\n');
    }

    function replaceUnicodeDashes(text) {
      return String(text ?? '').replace(/[\u2013\u2014]/g, '-');
    }

    function normalizeTime(value) {
      const match = value.trim().toLowerCase().match(/^(\d{1,2})[:h](\d{2})h?$/);
      if (!match) {
        return value.trim();
      }
      let [_, hh, mm] = match;
      const hour = String(Number(hh)).padStart(2, '0');
      return `${hour}:${mm}`;
    }

    function applyRulesToText(text) {
      const original = String(text ?? '').trim();
      if (!original) {
        return original;
      }

      const normalizedInput = normalizeMatchText(original);
      const rules = obterRegras();

      for (const rule of rules) {
        if (!rule || !rule.match) continue;
        const normalizedRule = normalizeMatchText(rule.match);
        if (normalizedRule && (normalizedInput === normalizedRule || normalizedInput.includes(normalizedRule))) {
          return rule.value?.trim() ?? original;
        }
      }

      return original;
    }

    function isYesNoStatus(text) {
      const normalized = normalizeMatchText(text);
      return normalized === 'sim' || normalized === 'nao' || normalized === 'n√£o';
    }

    function sanitizeAtuacao(value) {
      const text = String(value ?? '').trim();
      if (!text) return '';

      if (isYesNoStatus(text)) {
        return text.replace(/[.!?]+$/, '');
      }

      return text;
    }

    function normalizeStatus(value) {
      const sanitized = sanitizeAtuacao(applyRulesToText(value));

      if (!isYesNoStatus(sanitized) && sanitized && !/[.!?]$/.test(sanitized)) {
        return `${sanitized}.`;
      }

      return sanitized;
    }

    function stripAccents(text) {
      return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function normalizeMatchText(text) {
      return stripAccents(String(text)).toLowerCase().replace(/\s+/g, ' ').trim().replace(/[.!?]+$/, '');
    }

    function obterRegras() {
      return [...userRules, ...defaultRules];
    }

    function normalizeCatalogValue(text) {
      return normalizeMatchText(text);
    }

    function obterCatalogoPorTipo(tipo) {
      return catalogEntries.filter((entry) => normalizeMatchText(entry.type || '') === normalizeMatchText(tipo));
    }

    function encontrarServicoNoCatalogo(texto) {
      const normalized = normalizeCatalogValue(texto);
      const services = obterCatalogoPorTipo('Servi√ßo');
      return services.find((entry) => {
        const normalizedEntry = normalizeCatalogValue(entry.text);
        return normalizedEntry && normalized.includes(normalizedEntry);
      });
    }

    function tentarClassificarLinhaPorCatalogo(line) {
      const sanitized = replaceUnicodeDashes(line.trim());
      if (!sanitized) return null;

      const timeMatch = sanitized.match(/^(\d{1,2}[:h]\d{2}h?)\s*[-‚Äì]?\s*(.+)$/i);
      if (!timeMatch) return null;

      const [, rawTime, rest] = timeMatch;
      const serviceCatalog = encontrarServicoNoCatalogo(rest);
      if (!serviceCatalog) return null;

      const time = normalizeTime(rawTime);
      const service = applyRulesToText(serviceCatalog.text).toUpperCase();

      const escapedService = serviceCatalog.text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const afterService = rest.replace(new RegExp(escapedService, 'i'), '').replace(/^[\s-‚Äì]+/, '').trim();

      let companies = [];
      let statusText = afterService;

      if (afterService.includes('-')) {
        const fragments = afterService.split(/\s*[-‚Äì]\s*/).filter(Boolean);
        if (fragments.length) {
          companies.push(fragments.shift());
          statusText = fragments.join(' - ');
        }
      }

      if (!statusText) {
        statusText = serviceCatalog.text;
      }

      const status = normalizeStatus(statusText);

      return {
        time,
        service,
        companies: companies.map((c) => applyRulesToText(c).toUpperCase()),
        status
      };
    }

    function incDate(dateStr) {
      const parts = dateStr.split('/').map(Number);
      if (parts.length !== 3 || parts.some(Number.isNaN)) {
        return dateStr;
      }
      const [day, month, year] = parts;
      const date = new Date(year, month - 1, day);
      date.setDate(date.getDate() + 1);
      const nextDay = String(date.getDate()).padStart(2, '0');
      const nextMonth = String(date.getMonth() + 1).padStart(2, '0');
      const nextYear = date.getFullYear();
      return `${nextDay}/${nextMonth}/${nextYear}`;
    }

    async function copiar() {
      const text = document.getElementById('out').textContent;
      if (!text) {
        alert('N√£o h√° conte√∫do para copiar.');
        return;
      }
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          throw new Error('Clipboard API indispon√≠vel');
        }
        alert('Lista copiada para a √°rea de transfer√™ncia!');
      } catch (err) {
        try {
          const temp = document.createElement('textarea');
          temp.value = text;
          temp.setAttribute('readonly', '');
          temp.style.position = 'fixed';
          temp.style.opacity = '0';
          document.body.appendChild(temp);
          temp.select();
          const successful = document.execCommand('copy');
          document.body.removeChild(temp);
          if (successful) {
            alert('Lista copiada para a √°rea de transfer√™ncia!');
            return;
          }
          throw new Error('Falha ao copiar');
        } catch (fallbackError) {
          alert('N√£o foi poss√≠vel copiar automaticamente. Copie manualmente.');
        }
      }
    }

    function limpar() {
      document.getElementById('in').value = '';
      document.getElementById('out').textContent = '';
      document.getElementById('in').focus();
    }

    function carregarRegras() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) {
        userRules = [];
        return;
      }
      try {
        const parsed = JSON.parse(saved);
        if (Array.isArray(parsed)) {
          userRules = parsed.filter((rule) => rule && typeof rule.match === 'string');
        }
      } catch (error) {
        userRules = [];
      }
    }

    function salvarRegra() {
      const match = document.getElementById('ruleMatch').value.trim();
      const value = document.getElementById('ruleValue').value.trim();
      if (!match || !value) {
        alert('Preencha o texto a detectar e a substitui√ß√£o.');
        return;
      }

      const newRule = { match, value };

      if (editingIndex !== null && editingIndex >= 0 && editingIndex < userRules.length) {
        userRules[editingIndex] = newRule;
        editingIndex = null;
      } else {
        userRules.push(newRule);
      }

      persistirRegras();
      limparCamposRegra();
      renderizarRegras();
    }

    function persistirRegras() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(userRules));
    }

    function limparCamposRegra() {
      document.getElementById('ruleMatch').value = '';
      document.getElementById('ruleValue').value = '';
      document.getElementById('ruleSaveButton').textContent = 'Salvar regra';
    }

    function renderizarRegras() {
      const container = document.getElementById('rulesList');
      container.innerHTML = '';

      const allRules = obterRegras();
      if (!allRules.length) {
        container.textContent = 'Nenhuma regra cadastrada.';
        return;
      }

      allRules.forEach((rule, index) => {
        const item = document.createElement('div');
        item.className = 'rule-item';

        const texts = document.createElement('div');
        texts.className = 'rule-texts';
        texts.innerHTML = `<strong>${rule.value}</strong><span>${rule.match}</span>`;

        const buttons = document.createElement('div');
        buttons.className = 'rule-buttons';

        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'secondary small-button';
        editBtn.textContent = 'Editar';
        editBtn.onclick = () => editarRegra(index);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'danger small-button';
        removeBtn.textContent = 'Remover';
        removeBtn.onclick = () => removerRegra(index);

        buttons.appendChild(editBtn);
        buttons.appendChild(removeBtn);

        item.appendChild(texts);
        item.appendChild(buttons);
        container.appendChild(item);
      });
    }

    function editarRegra(index) {
      const allRules = obterRegras();
      const rule = allRules[index];
      if (!rule) return;

      editingIndex = index >= userRules.length ? userRules.length : index;

      document.getElementById('ruleMatch').value = rule.match;
      document.getElementById('ruleValue').value = rule.value;
      document.getElementById('ruleSaveButton').textContent = 'Atualizar regra';
    }

    function removerRegra(index) {
      if (index >= userRules.length) {
        alert('N√£o √© poss√≠vel remover regras padr√£o. Edite-as para sobrescrever.');
        return;
      }
      userRules.splice(index, 1);
      persistirRegras();
      renderizarRegras();
      cancelarEdicao();
    }

    function cancelarEdicao() {
      editingIndex = null;
      limparCamposRegra();
    }

    function carregarCatalogo() {
      const saved = localStorage.getItem(CATALOG_KEY);
      if (!saved) {
        catalogEntries = [];
        return;
      }

      try {
        const parsed = JSON.parse(saved);
        if (Array.isArray(parsed)) {
          catalogEntries = parsed
            .filter((entry) => entry && typeof entry.text === 'string')
            .map((entry) => ({
              type: entry.type || 'Servi√ßo',
              text: entry.text
            }));
        }
      } catch (error) {
        catalogEntries = [];
      }
    }

    function persistirCatalogo() {
      localStorage.setItem(CATALOG_KEY, JSON.stringify(catalogEntries));
    }

    function limparCamposCatalogo() {
      document.getElementById('catalogText').value = '';
      document.getElementById('catalogType').value = 'Servi√ßo';
    }

    function adicionarEntradaCatalogo() {
      const type = document.getElementById('catalogType').value || 'Servi√ßo';
      const text = document.getElementById('catalogText').value.trim();

      if (!text) {
        alert('Informe o texto a identificar.');
        return;
      }

      catalogEntries.push({ type, text });
      persistirCatalogo();
      renderizarCatalogo();
      limparCamposCatalogo();
    }

    function removerEntradaCatalogo(index) {
      catalogEntries.splice(index, 1);
      persistirCatalogo();
      renderizarCatalogo();
    }

    function renderizarCatalogo() {
      const list = document.getElementById('catalogList');
      list.innerHTML = '';

      if (!catalogEntries.length) {
        const empty = document.createElement('div');
        empty.className = 'catalog-empty';
        empty.textContent = 'Nenhuma entrada cadastrada.';
        list.appendChild(empty);
        return;
      }

      catalogEntries.forEach((entry, index) => {
        const item = document.createElement('div');
        item.className = 'catalog-item';

        const texts = document.createElement('div');
        texts.className = 'catalog-texts';
        texts.innerHTML = `<span class="catalog-type">${entry.type || 'Servi√ßo'}</span><strong>${entry.text}</strong>`;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'danger small-button';
        removeBtn.textContent = 'Remover';
        removeBtn.onclick = () => removerEntradaCatalogo(index);

        item.appendChild(texts);
        item.appendChild(removeBtn);
        list.appendChild(item);
      });
    }

    // üîπ NOVO: converte date (dd/MM/yyyy) + time (HH:mm) para UTC com Z, somando 3h
    function formatarDataHoraUTC(row) {
      if (!row || !row.date || !row.time) return '';

      const [dia, mes, ano] = row.date.split('/').map(Number);
      const [hh, mm] = row.time.split(':').map(Number);

      // soma 3h (UTC-3 -> UTC); Date.UTC lida com overflow (24+)
      const date = new Date(Date.UTC(ano, mes - 1, dia, hh + 3, mm, 0));

      // yyyy-MM-ddTHH:mm:ssZ
      return date.toISOString().replace('.000Z', 'Z');
    }

    // usa o helper acima tanto para XLSX quanto para CSV
    function mapForExport(rows) {
      return rows.map((row) => ({
        DataHora: formatarDataHoraUTC(row),
        Servi√ßo: row.service ?? '',
        Empresa: row.company ?? '',
        Observa√ß√£o: row.observacao ?? '',
        Atua√ß√£o: sanitizeAtuacao(row.atuacao ?? row.status ?? '')
      }));
    }

    function mapearParaExportacaoXLSX(linhas) {
      return linhas.map((row) => ({
        DataHora: row.dataHora || (row.date && row.time ? `${row.date}T${row.time}:00Z` : ''),
        Servico: row.service ?? '',
        Empresa: row.company ?? '',
        Observacao: row.observacao ?? '',
        Atuacao: sanitizeAtuacao(row.atuacao ?? row.status ?? '')
      }));
    }

    async function exportarXLSX() {
      if (!formattedRows.length) {
        formatar();
      }

      if (!formattedRows.length) {
        alert('N√£o h√° conte√∫do formatado para exportar.');
        return;
      }

      if (!window.XLSX) {
        alert('Biblioteca XLSX n√£o foi carregada. Tente recarregar a p√°gina.');
        return;
      }

      const mappedRows = mapForExport(formattedRows);
      const worksheet = XLSX.utils.json_to_sheet(mappedRows, {
        header: ['DataHora', 'Servi√ßo', 'Empresa', 'Observa√ß√£o', 'Atua√ß√£o']
      });

      worksheet['!cols'] = [
        { wch: 22 },
        { wch: 28 },
        { wch: 28 },
        { wch: 50 },
        { wch: 22 }
      ];

      const range =
        worksheet['!ref'] ||
        XLSX.utils.encode_range({ s: { c: 0, r: 0 }, e: { c: 4, r: mappedRows.length } });
      worksheet['!ref'] = range;
      worksheet['!autofilter'] = { ref: range };

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Registros');

      const timestamp = new Date().toISOString().replace(/[:T]/g, '-').split('.')[0];
      XLSX.writeFile(workbook, `noc-formatter-${timestamp}.xlsx`);
    }

    function exportarCSV() {
      if (!formattedRows.length) {
        formatar();
      }

      if (!formattedRows.length) {
        alert('N√£o h√° conte√∫do formatado para exportar.');
        return;
      }

      const data = [
        ['DataHora', 'Servi√ßo', 'Empresa', 'Observa√ß√£o', 'Atua√ß√£o'],
        ...formattedRows.map((row) => [
          formatarDataHoraUTC(row),
          row.service ?? '',
          row.company ?? '',
          row.observacao ?? '',
          row.atuacao ?? row.status ?? ''
        ])
      ];

      const csv = data.map((row) => row.map(escaparCSV).join(';')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      const timestamp = new Date().toISOString().replace(/[:T]/g, '-').split('.')[0];
      link.download = `noc-formatter-${timestamp}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);

      const offlineMessage = !window.XLSX
        ? '\nA biblioteca XLSX n√£o p√¥de ser carregada; o arquivo foi exportado como CSV.'
        : '';
      alert(`Exporta√ß√£o conclu√≠da.${offlineMessage}`);
    }

    function escaparCSV(valor) {
      const text = String(valor ?? '');
      if (/[";\n]/.test(text)) {
        return `"${text.replace(/"/g, '""')}"`;
      }
      return text;
    }
  </script>
</body>
</html>
